name: decomplex-e2e

services:
  postgres-e2e:
    image: postgres:16-alpine
    container_name: decomplex-postgres-e2e
    environment:
      POSTGRES_DB: decomplex_e2e
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Decomplex5555
    ports:
      - "55433:5432"
    volumes:
      - pg_data_e2e:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d decomplex_e2e"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks: [e2enet]

  redis-e2e:
    image: redis:7-alpine
    container_name: decomplex-redis-e2e
    ports:
      - "56380:6379"
    command: ["redis-server", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks: [e2enet]

  rabbitmq-e2e:
    image: rabbitmq:3-management-alpine
    container_name: decomplex-rabbitmq-e2e
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5674:5672"
      - "15674:15672"
    volumes:
      - rabbitmq_data_e2e:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks: [e2enet]

  backend-e2e:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: test
    container_name: decomplex-backend-e2e
    env_file:
      - .env.e2e.docker
    depends_on:
      postgres-e2e:
        condition: service_healthy
      redis-e2e:
        condition: service_healthy
      rabbitmq-e2e:
        condition: service_healthy
    ports:
      - "4100:4100"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:4100/health >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks: [e2enet]

networks:
  e2enet:
    driver: bridge

volumes:
  pg_data_e2e:
  rabbitmq_data_e2e:
